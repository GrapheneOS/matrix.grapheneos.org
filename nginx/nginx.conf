load_module modules/ngx_http_brotli_static_module.so;

error_log syslog:server=unix:/run/nginx-error-log,nohostname;
# leave stderr open but minimize duplicate logging to it
error_log stderr emerg;

worker_processes auto;
worker_rlimit_nofile 16384;
worker_shutdown_timeout 1h;

events {
    worker_connections 4096;
}

http {
    root /var/empty;

    include mime.types;
    default_type application/octet-stream;

    charset utf-8;
    charset_types text/css text/javascript text/plain text/xml application/atom+xml;

    sendfile on;
    sendfile_max_chunk 256k;
    tcp_nopush on;
    keepalive_requests 10000;
    keepalive_timeout 0;
    server_tokens off;
    msie_padding off;

    client_max_body_size 1k;
    client_body_buffer_size 1k;
    client_header_buffer_size 1k;
    large_client_header_buffers 2 1k;
    http2_chunk_size 4k;

    reset_timedout_connection on;
    client_body_timeout 15s;
    client_header_timeout 15s;
    send_timeout 30s;

    max_ranges 1;

    resolver [::1];
    resolver_timeout 15s;

    http2_max_concurrent_streams 16;
    limit_conn_status 429;
    limit_conn_zone $binary_remote_addr zone=http-limit:10m;
    limit_conn http-limit 128;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;
    ssl_conf_command Options PrioritizeChaCha;

    ssl_certificate /etc/letsencrypt/live/matrix.grapheneos.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/matrix.grapheneos.org/privkey.pem;

    # managed externally in noswap tmpfs
    ssl_session_ticket_key /etc/tls/session-ticket-keys/4.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/3.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/2.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/1.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/next.key;
    ssl_session_timeout 1d;
    ssl_buffer_size 4k;

    log_format main '$connection-$connection_requests $remote_addr $remote_user $ssl_session_reused $ssl_protocol $server_protocol '
        '$host $request_method "$request_uri" $status $request_length $body_bytes_sent/$bytes_sent '
        '$request_time $upstream_connect_time/$upstream_header_time/$upstream_response_time '
        '$upstream_cache_status "$http_referer" "$http_user_agent"';
    access_log syslog:server=unix:/run/nginx-access-log,nohostname main;
    log_subrequest on;
    log_not_found off;

    gzip_proxied any;
    gzip_vary on;

    if_modified_since before;

    aio threads;
    aio_write on;

    upstream synapse-main {
        zone synapse-main 32k;
        server unix:/run/synapse/main_public.sock max_conns=4096 max_fails=0;
    }

    upstream synapse-sync {
        zone synapse-sync 32k;
        server unix:/run/synapse/sync_public.sock max_conns=4096 max_fails=0;
    }

    upstream synapse-client_reader {
        zone synapse-client_reader 32k;
        server unix:/run/synapse/client_reader_public.sock max_conns=4096 max_fails=0;
    }

    upstream synapse-federation_reader {
        zone synapse-federation_reader 32k;
        server unix:/run/synapse/federation_reader_public.sock max_conns=4096 max_fails=0;
    }

    upstream synapse-media_repository {
        zone synapse-media_repository 32k;
        server unix:/run/synapse/media_repository_public.sock max_conns=4096 max_fails=0;
    }

    upstream synapse-stream_writer {
        zone synapse-stream_writer 32k;
        server unix:/run/synapse/stream_writer_public.sock max_conns=4096 max_fails=0;
    }

    upstream synapse-user_dir {
        zone synapse-user_dir 32k;
        server unix:/run/synapse/user_dir_public.sock max_conns=4096 max_fails=0;
    }

    server {
        listen 80 default_server backlog=4096 fastopen=16 rcvbuf=2048 sndbuf=2048;
        listen [::]:80 default_server backlog=4096 fastopen=16 rcvbuf=2048 sndbuf=2048;

        # https://trac.nginx.org/nginx/ticket/2012
        location / {
            return 421;
        }
    }

    server {
        listen 80;
        listen [::]:80;
        server_name matrix.grapheneos.org element.grapheneos.org;

        location /.well-known/acme-challenge/ {
            root /srv/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 default_server ssl backlog=4096 fastopen=16;
        listen [::]:443 default_server ssl backlog=4096 fastopen=16;
        http2 on;
        ssl_reject_handshake on;

        # https://trac.nginx.org/nginx/ticket/2012
        location / {
            return 421;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        listen unix:/run/nginx/matrix.sock;
        http2 on;
        server_name matrix.grapheneos.org;

        keepalive_timeout 3m;

        include snippets/security-headers.conf;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Content-Security-Policy "font-src 'none'; manifest-src 'none'; object-src 'none'; script-src 'none'; style-src 'none'; frame-ancestors 'none'" always;
        # obsolete and replaced with Content-Security-Policy frame-ancestors 'none'
        add_header X-Frame-Options "DENY" always;

        location = / {
            return 301 https://grapheneos.org/articles/grapheneos-servers#matrix.grapheneos.org;
        }

        location /_matrix/ {
            # remove security headers that are statically set to the strictest possible values below
            proxy_hide_header Referrer-Policy;
            proxy_hide_header X-Frame-Options;

            include snippets/security-headers.conf;
            add_header Content-Security-Policy "font-src 'none'; manifest-src 'none'; object-src 'none'; script-src 'none'; style-src 'none'; frame-ancestors 'none'" always;
            # obsolete and replaced with Content-Security-Policy frame-ancestors 'none'
            add_header X-Frame-Options "DENY" always;
            add_header X-Robots-Tag "none" always;

            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;
            proxy_connect_timeout 5s;
            proxy_send_timeout 15s;
            proxy_read_timeout 600s;

            client_max_body_size 100m;
            client_body_buffer_size 16k;

            proxy_pass http://synapse-main;

            location ~ ^/_matrix/client/(?:r0|v3)/sync$|^/_matrix/client/(?:api/v1|r0|v3)/events$|^/_matrix/client/(?:api/v1|r0|v3)/initialSync$|^/_matrix/client/(?:api/v1|r0|v3)/rooms/[^/]+/initialSync$|^/_matrix/client/unstable/org.matrix.simplified_msc3575/sync$ {
                proxy_pass http://synapse-sync;
            }

            location ~ ^/_matrix/client/(?:api/v1|r0|v3|unstable)/createRoom$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/publicRooms$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/joined_members$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/context/.*$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/members$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/state$|^/_matrix/client/v1/rooms/.*/hierarchy$|^/_matrix/client/(?:v1|unstable)/rooms/.*/relations/|^/_matrix/client/v1/rooms/.*/threads$|^/_matrix/client/unstable/im.nheko.summary/rooms/.*/summary$|^/_matrix/client/unstable/im.nheko.summary/summary/.*$|^/_matrix/client/(?:r0|v3|unstable)/account/3pid$|^/_matrix/client/(?:r0|v3|unstable)/account/whoami$|^/_matrix/client/(?:r0|v3|unstable)/account/deactivate$|^/_matrix/client/(?:r0|v3)/delete_devices$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/devices(?:/|$)|^/_matrix/client/versions$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/voip/turnServer$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/event/|^/_matrix/client/(?:api/v1|r0|v3|unstable)/joined_rooms$|^/_matrix/client/v1/rooms/.*/timestamp_to_event$|^/_matrix/client/(?:api/v1|r0|v3|unstable/.*)/rooms/.*/aliases|^/_matrix/client/(?:api/v1|r0|v3|unstable)/search$|^/_matrix/client/(?:r0|v3|unstable)/user/.*/filter(?:/|$)|^/_matrix/client/(?:api/v1|r0|v3|unstable)/directory/room/.*$|^/_matrix/client/(?:r0|v3|unstable)/capabilities$|^/_matrix/client/(?:r0|v3|unstable)/notifications$|^/_matrix/client/(?:r0|v3|unstable)/keys/query$|^/_matrix/client/(?:r0|v3|unstable)/keys/changes$|^/_matrix/client/(?:r0|v3|unstable)/keys/claim$|^/_matrix/client/(?:r0|v3|unstable)/room_keys/|^/_matrix/client/(?:r0|v3|unstable)/keys/upload|^/_matrix/client/(?:api/v1|r0|v3|unstable)/keys/device_signing/upload$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/keys/signatures/upload$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/login$|^/_matrix/client/(?:r0|v3|unstable)/register$|^/_matrix/client/(?:r0|v3|unstable)/register/available$|^/_matrix/client/v1/register/m.login.registration_token/validity$|^/_matrix/client/(?:r0|v3|unstable)/password_policy$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/redact|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/send|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/state/|^/_matrix/client/(?:api/v1|r0|v3|unstable)/rooms/.*/(?:join|invite|leave|ban|unban|kick)$|^/_matrix/client/(?:api/v1|r0|v3|unstable)/join/|^/_matrix/client/(?:api/v1|r0|v3|unstable)/knock/|^/_matrix/client/(?:api/v1|r0|v3|unstable)/profile/|^/_matrix/client/unstable/org.matrix.msc4140/delayed_events(?:/.*/restart)?$|^/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/messages$ {
                proxy_pass http://synapse-client_reader;
            }

            location ~ ^/_matrix/federation/v1/version$|^/_matrix/federation/v1/event/|^/_matrix/federation/v1/state/|^/_matrix/federation/v1/state_ids/|^/_matrix/federation/v1/backfill/|^/_matrix/federation/v1/get_missing_events/|^/_matrix/federation/v1/publicRooms|^/_matrix/federation/v1/query/|^/_matrix/federation/v1/make_join/|^/_matrix/federation/v1/make_leave/|^/_matrix/federation/(:?v1|v2)/send_join/|^/_matrix/federation/(:?v1|v2)/send_leave/|^/_matrix/federation/v1/make_knock/|^/_matrix/federation/v1/send_knock/|^/_matrix/federation/(:?v1|v2)/invite/|^/_matrix/federation/v1/event_auth/|^/_matrix/federation/v1/timestamp_to_event/|^/_matrix/federation/v1/exchange_third_party_invite/|^/_matrix/federation/v1/user/devices/|^/_matrix/key/v2/query|^/_matrix/federation/v1/hierarchy/|^/_matrix/federation/v1/send/ {
                proxy_pass http://synapse-federation_reader;
            }

            location ~ ^/_matrix/media/|^/_matrix/client/v1/media/|^/_matrix/federation/v1/media/ {
                proxy_pass http://synapse-media_repository;
            }

            location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/rooms/.*/typing|^/_matrix/client/(r0|v3|unstable)/sendToDevice/|^/_matrix/client/(r0|v3|unstable)/.*/tags|^/_matrix/client/(r0|v3|unstable)/.*/account_data|^/_matrix/client/(r0|v3|unstable)/rooms/.*/receipt|^/_matrix/client/(r0|v3|unstable)/rooms/.*/read_markers|^/_matrix/client/(api/v1|r0|v3|unstable)/presence/|^/_matrix/client/(api/v1|r0|v3|unstable)/pushrules/|^/_matrix/client/(r0|v3)/delete_devices$|^/_matrix/client/(api/v1|r0|v3|unstable)/devices(/|$)|^/_matrix/client/(r0|v3|unstable)/keys/upload|^/_matrix/client/(api/v1|r0|v3|unstable)/keys/device_signing/upload$|^/_matrix/client/(api/v1|r0|v3|unstable)/keys/signatures/upload$ {
                proxy_pass http://synapse-stream_writer;
            }

            location ~ ^/_matrix/client/(r0|v3|unstable)/user_directory/search$ {
                proxy_pass http://synapse-user_dir;
            }
        }

        location /_synapse/admin/ {
            allow unix:;
            deny all;

            # remove security headers that are statically set to the strictest possible values below
            proxy_hide_header Referrer-Policy;
            proxy_hide_header X-Frame-Options;

            include snippets/security-headers.conf;
            add_header Content-Security-Policy "font-src 'none'; manifest-src 'none'; object-src 'none'; script-src 'none'; style-src 'none'; frame-ancestors 'none'" always;
            # obsolete and replaced with Content-Security-Policy frame-ancestors 'none'
            add_header X-Frame-Options "DENY" always;
            add_header X-Robots-Tag "none" always;

            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;
            proxy_connect_timeout 5s;
            proxy_send_timeout 15s;
            proxy_read_timeout 600s;

            client_max_body_size 100m;
            client_body_buffer_size 16k;

            proxy_pass http://synapse-main;

            location ~ ^/_synapse/admin/v1/rooms/[^/]+$ {
                proxy_pass http://synapse-client_reader;
            }

            location ~ ^/_synapse/admin/v1/purge_media_cache$|^/_synapse/admin/v1/room/.*/media.*$|^/_synapse/admin/v1/user/.*/media.*$|^/_synapse/admin/v1/media/.*$|^/_synapse/admin/v1/quarantine_media/.*$|^/_synapse/admin/v1/users/.*/media$ {
                proxy_pass http://synapse-media_repository;
            }
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name element.grapheneos.org;

        include root_element.grapheneos.org.conf;

        keepalive_timeout 3m;

        include snippets/security-headers.conf;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        add_header Content-Security-Policy "font-src 'self'; manifest-src 'self'; object-src 'none'; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; frame-ancestors 'self'" always;
        # obsolete and replaced with Content-Security-Policy frame-ancestors 'self'
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Robots-Tag "none" always;

        location ~ '\.(?:css|html|ico|js|json|map|svg|txt|wasm|xml)$' {
            gzip_static on;
            brotli_static on;
        }
    }

    server {
        listen unix:/run/nginx/status.sock;

        access_log off;

        location = / {
            stub_status;
        }

        location / {
            return 404;
        }
    }
}
