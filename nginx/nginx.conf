# nginx 1.20.2+

load_module modules/ngx_http_brotli_static_module.so;

worker_processes auto;
worker_rlimit_nofile 16384;

events {
    worker_connections 4096;
}

http {
    include mime.types;
    default_type application/octet-stream;

    charset utf-8;
    charset_types text/css text/plain text/xml application/atom+xml application/javascript;

    # sendfile + AIO is buggy without fixes from nginx master
    #sendfile on;
    sendfile_max_chunk 512k;
    tcp_nopush on;
    keepalive_timeout 3m;
    server_tokens off;
    msie_padding off;

    client_max_body_size 1k;
    client_body_buffer_size 1k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    http2_recv_buffer_size 128k;

    client_body_timeout 30s;
    client_header_timeout 30s;
    send_timeout 30s;

    http2_max_concurrent_streams 32;
    limit_conn_status 429;
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    limit_conn addr 256;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;
    ssl_conf_command Options PrioritizeChaCha;

    ssl_certificate /etc/letsencrypt/live/matrix.grapheneos.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/matrix.grapheneos.org/privkey.pem;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    # maintained by nginx-rotate-session-ticket-keys in ramfs
    ssl_session_ticket_key session-ticket-keys/4.key;
    ssl_session_ticket_key session-ticket-keys/3.key;
    ssl_session_ticket_key session-ticket-keys/2.key;
    ssl_session_ticket_key session-ticket-keys/1.key;
    ssl_buffer_size 4k;

    ssl_trusted_certificate /etc/letsencrypt/live/matrix.grapheneos.org/chain.pem;
    ssl_stapling on;
    ssl_stapling_verify on;
    # maintained by certbot-ocsp-fetcher
    ssl_stapling_file ocsp-cache/matrix.grapheneos.org.der;

    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request_method $scheme://$host$request_uri $server_protocol" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';
    access_log /var/log/nginx/access.log main buffer=64k flush=1m;
    error_log syslog:server=unix:/dev/log,nohostname;
    log_not_found off;

    gzip_proxied any;
    gzip_vary on;

    if_modified_since before;

    aio threads;
    aio_write on;

    upstream backend {
        zone backend 32k;
        server [::1]:8008 max_conns=4096 fail_timeout=1s;
    }

    server {
        listen 80 backlog=4096;
        listen [::]:80 backlog=4096;
        server_name matrix.grapheneos.org element.grapheneos.org;

        root /var/empty;

        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2 backlog=4096;
        listen [::]:443 ssl http2 backlog=4096;
        server_name matrix.grapheneos.org;

        # ellipsys.xyz
        deny 159.89.231.176;
        # matrix.mistli.net
        deny 50.21.186.239;
        # cocobean.cc
        deny 159.203.3.102;
        # obermui.de
        deny 80.241.216.82;
        # obermui.de
        deny 2a02:c205:3004:663::1;
        # nibbana.jp
        deny 153.127.39.131;
        # matrix.familyhainz.de
        deny 173.249.20.201;
        # home.troback.com
        deny 195.216.38.112;
        # matrix.mfietze.de
        deny 45.9.63.237;
        # gcsg.zitech.cyou
        deny 203.24.92.68;
        # pittamitz.at
        deny 89.163.150.203;
        # wrservers.ovh
        deny 146.59.18.223;
        # z.aphi.kz
        deny 213.157.55.59;
        # matrix.philobyte.com
        deny 95.208.159.115;
        # matrix.tmiland.com
        deny 142.93.231.0;
        # srv01.st0rm.cloud
        deny 65.21.141.45;
        # srv01.st0rm.cloud
        deny 2a01:4f9:3b:2a92::2;
        # weuse.spdns.org
        deny 195.176.247.87;
        # matrix.racistism.tk
        deny 129.151.81.216;
        # cisek.ca
        deny 45.33.44.6;
        # matrix.schotty.com
        deny 96.126.125.111;
        # matrix.schotty.com
        deny 2600:3c00::f03c:91ff:fe7e:5fa6;
        # bar.lerp.com
        deny 144.217.91.71;
        # troplo.com
        deny 104.21.62.235;
        # troplo.com
        deny 172.67.140.35;
        # troplo.com
        deny 2606:4700:3036::ac43:8c23;
        # troplo.com
        deny 2606:4700:3032::6815:3eeb;
        # matrix.thoughtless.eu
        deny 5.39.75.213;
        # beckendoktor.com
        deny 91.64.206.128;
        # crossroads.duncanturk.com
        deny 138.201.248.73;
        # avlikos.gr
        deny 78.46.65.188;
        # wl.adviser.com
        deny 90.187.222.173;
        # wl.adviser.com
        deny 2a02:8106:2a:3c00::25;
        # kde.org
        #deny 136.243.103.182;
        # kde.org
        #deny 2a01:4f8:171:c9a::5;
        # matrix.hopfenspace.org
        deny 49.12.90.188;
        # matrix.hopfenspace.org
        deny 2a01:4f8:d0:c300:1337::117;
        # beatsnet.com
        deny 80.254.165.132;
        # beatsnet.com
        deny 2a01:2a8:8507:4201::99;
        # home.troback.com
        deny 195.216.38.112;
        # weuse.spdns.org
        deny 195.176.247.87;
        # domus.ds-guiraud.fr
        deny 82.66.16.47;
        # wrservers.ovh
        deny 146.59.18.223;
        # ellipsys.xyz
        deny 159.89.231.176;
        # houtworm.im
        deny 62.195.173.14;
        # matrix.nortsat.pl
        deny 146.59.12.19;
        # matrix.lorenzo12floxy.ga
        deny 87.208.181.46;
        # natserver.dresel.systems
        deny 188.40.122.107;
        # natserver.dresel.systems
        deny 2a01:4f8:221:2d08::100;
        # matrix.niklasfi.de
        deny 144.76.34.124;
        # cocobean.cc
        deny 159.203.3.102;
        # matrix.muensterhack.de
        deny 51.116.175.36;
        # matrix.expectnomore.net
        deny 172.104.27.109;
        # matrix.familyhainz.de
        deny 173.249.20.201;
        # matrix.hopfenspace.org
        deny 49.12.90.188;
        # matrix.hopfenspace.org
        deny 2a01:4f8:d0:c300:1337::117;
        # matrix.wolfwarrior.de
        deny 207.180.231.150;
        # matrix.complb.de
        deny 78.46.183.5;
        # matrix.airgapped.systems
        deny 98.117.67.43;
        # tricuties.com
        deny 35.190.63.162;
        # tricuties.com
        deny 2600:1901:0:efab::;
        # foobar.style
        deny 138.197.14.28;
        # juniorjpdj.pl
        deny 213.5.209.100;
        # lcda-nwn2.fr
        deny 37.187.155.130;
        # lcda-nwn2.fr
        deny 2001:41d0:a:5b82::1;
        # chat.paralilo.net
        deny 173.249.9.95;
        # fick.es
        deny 88.99.67.72;
        # matrixtest.strits.dk
        deny 212.10.35.169;
        # matrix.meissner.cc
        deny 80.143.171.246;
        # matrix.meissner.cc
        deny 2003:d5:703:cb00:aaa1:59ff:fe02:f3ba;
        # matrix.ericmesa.com
        deny 157.230.88.145;
        # dabbill.com
        deny 174.31.247.40;
        # lodere.es
        deny 116.203.78.33;
        # lodere.es
        deny 2a01:4f8:1c1c:d46e::;
        # app-1.prod.dnlr.org
        deny 202.61.205.16;
        # ibab.space
        deny 174.91.219.176;
        # p3a.io
        deny 207.180.238.72;
        # technopagans.de
        deny 173.249.57.115;
        # technopagans.de
        deny 2a02:c207:3005:4218::1;
        # strangeplace.net
        deny 78.54.238.110;
        # lolison.chat
        deny 198.98.51.223;
        # matrix.znurre.com
        deny 147.78.194.12;
        # matrix.znurre.com
        deny 2a0a:e5c0:10:3::b4e5;
        # matrix.flash-messenger.ml
        deny 93.90.82.247;
        # netrunner-vault.de
        deny 95.88.11.17;
        # hq.snug.moe
        deny 5.14.123.181;
        # hq.snug.moe
        deny 2a02:2f0c:f304:c00:f2de:f1ff:fe67:dd64;
        # matrix.dificen.to
        deny 185.45.112.245;
        # matrix.dpin.de
        deny 176.9.46.34;
        # matrix.dpin.de
        deny 2a01:4f8:150:6227::2;
        # matrix.danyocean.com
        deny 91.121.90.123;
        # vicious.space
        deny 144.2.71.134;
        # matrix.vitoy.xyz
        deny 134.209.250.45;
        # matrix.okoyono.de
        deny 193.26.156.113;
        # home.troback.com
        deny 195.216.38.112;
        # matrix.net4sec.com
        deny 62.67.240.34;
        # matrix.valentinleistner.com
        deny 87.154.179.143;
        # matrix.valentinleistner.com
        deny 2003:f6:970c:3000:2663:1254:1839:bbba;

        # m.wanwire.com
        deny  185.103.202.5;
        # synapse.yokai.cafe
        deny  85.195.238.242;
        # synapse.yokai.cafe
        deny  2a02:168:a067:2001:0:ff:fe00:228;
        # dfc.netcavy.net
        deny  159.196.21.76;
        # matrix.mueller.network
        deny  213.135.13.39;
        # mat.eaglecomputerrepairsc.com
        deny  95.216.158.36;
        # srv01.st0rm.cloud
        deny  65.21.141.45;
        # srv01.st0rm.cloud
        deny  2a01:4f9:3b:2a92::2;
        # celaphais.duckdns.org
        deny  50.34.61.83;
        # sgfc.co
        deny  150.107.72.89;
        # matrix.club-tech.fr is an alias for lcda-nwn2.fr.
        # lcda-nwn2.fr
        deny  37.187.155.130;
        # lcda-nwn2.fr
        deny  2001:41d0:a:5b82::1;
        # matrix.netcavy.net is an alias for dfc.netcavy.net.
        # dfc.netcavy.net
        deny  159.196.21.76;

        # vicious.space
        deny 144.2.71.134;
        # synapse.duncanturk.com is an alias for crossroads.duncanturk.com.
        # crossroads.duncanturk.com
        deny 138.201.248.73;
        # jalr.de
        deny 78.47.224.233;
        # jalr.de
        deny 2a01:4f8:190:6068:c000::2;
        # obermui.de
        deny 80.241.216.82;
        # obermui.de
        deny 2a02:c205:3004:663::1;
        # dermm.io
        deny 5.189.174.181;
        # dermm.io
        deny 2a02:c207:3005:6857::1;
        # matrix.wolfwarrior.de
        deny 207.180.231.150;
        # matrix.valentinleistner.com
        deny 87.154.179.143;
        # matrix.valentinleistner.com
        deny 2003:f6:970c:3000:2663:1254:1839:bbba;
        # aymane.xyz
        deny 172.64.80.1;
        # aymane.xyz
        deny 2606:4700:130:436c:6f75:6466:6c61:7265;
        # matrix.lorenzo12floxy.ga
        deny 87.208.181.46;
        # matrix.dificen.to
        deny 185.45.112.245;
        deny 2a02:e00:fff0:522::a;

        root /var/empty;

        include snippets/security-headers.conf;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        add_header Content-Security-Policy "font-src 'none'; manifest-src 'none'; object-src 'none'; script-src 'none'; style-src 'none'; frame-ancestors 'none'; block-all-mixed-content" always;
        # obsolete and replaced with Content-Security-Policy frame-ancestors 'none'
        add_header X-Frame-Options "DENY" always;

        location = / {
            return 301 https://grapheneos.org/articles/grapheneos-servers#matrix.grapheneos.org;
        }

        location ~ ^(?:/_matrix|/_synapse/client) {
            # remove security headers that are statically set to the strictest possible values below
            proxy_hide_header Referrer-Policy;
            proxy_hide_header X-Frame-Options;

            include snippets/security-headers.conf;
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
            add_header Content-Security-Policy "font-src 'none'; manifest-src 'none'; object-src 'none'; script-src 'none'; style-src 'none'; frame-ancestors 'none'; block-all-mixed-content" always;
            # obsolete and replaced with Content-Security-Policy frame-ancestors 'none'
            add_header X-Frame-Options "DENY" always;
            add_header X-Robots-Tag "none";

            proxy_pass http://backend;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;
            proxy_read_timeout 600s;

            client_max_body_size 100m;
            client_body_buffer_size 16k;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name element.grapheneos.org;

        root /srv/element.grapheneos.org;

        include snippets/security-headers.conf;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        add_header Content-Security-Policy "font-src 'self'; manifest-src 'self'; object-src 'none'; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; frame-ancestors 'self'; block-all-mixed-content" always;
        # obsolete and replaced with Content-Security-Policy frame-ancestors 'self'
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Robots-Tag "none";

        location ~ '\.(?:css|html|ico|js|json|map|svg|txt|wasm|xml)$' {
            gzip_static on;
            brotli_static on;
        }
    }

    server {
        listen 127.0.0.1:81;
        listen [::1]:81;

        root /var/empty;

        location = /nginx_status {
            stub_status;
            access_log off;
        }

        location / {
            return 404;
        }
    }
}
